name: Build, Test, and Deploy
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  rust-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      
      - name: Run tests
        run: cargo test
  docker-test:
    needs: rust-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: guslee:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Check glibc version
        run: docker run --rm guslee:test ldd --version
      
      - name: Verify binary dependencies
        run: |
          echo "Checking binary dependencies..."
          docker run --rm guslee:test ldd ./guslee
          echo "Verifying no missing dependencies..."
          ! docker run --rm guslee:test ldd ./guslee | grep "not found"
      
      - name: Verify files exist
        run: |
          docker run --rm guslee:test ls -la /app
          docker run --rm guslee:test test -f ./guslee
          docker run --rm guslee:test test -d ./garden
          docker run --rm guslee:test test -d ./static
          docker run --rm guslee:test test -d ./templates
      
      - name: Start container
        run: |
          docker run -d -p 3000:3000 \
            -e LICHESS_API_TOKEN="test_lichess_token_12345" \
            -e LICHESS_USERNAME="test_user" \
            -e SPOTIFY_USER_ID="test_spotify_user_id" \
            -e SPOTIFY_CLIENT_ID="test_client_id" \
            -e SPOTIFY_CLIENT_SECRET="test_client_secret" \
            -e SPOTIFY_REFRESH_TOKEN="test_refresh_token" \
            -e STEAM_API_KEY="test_steam_api_key" \
            -e STEAM_ID="test_steam_id" \
            --name guslee-test guslee:test
      
      - name: Check container is running
        run: |
          sleep 2
          if [ "$(docker inspect -f '{{.State.Running}}' guslee-test)" == "true" ]; then
            echo "Container is running"
            docker ps --filter "name=guslee-test"
          else
            echo "Container failed to start"
            echo "Container status:"
            docker ps -a --filter "name=guslee-test"
            echo "Container logs:"
            docker logs guslee-test
            exit 1
          fi
      
      - name: Check application health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3000 2>/dev/null; then
              echo "Application is responding!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Application failed to respond"
              docker logs guslee-test
              exit 1
            fi
            echo "Waiting for application... attempt $i"
            sleep 2
          done
      
      - name: Show container logs
        if: always()
        run: docker logs guslee-test
      
      - name: Stop container
        if: always()
        run: docker stop guslee-test || true
  deploy:
    needs: [rust-test, docker-test]
    runs-on: ubuntu-latest
    # Only deploy on push to main (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
